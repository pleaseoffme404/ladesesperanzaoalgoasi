CREATE DATABASE IF NOT EXISTS panaderia_desesperanza CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE panaderia_desesperanza;

CREATE TABLE administradores (
    id_administrador INT AUTO_INCREMENT PRIMARY KEY,
    usuario VARCHAR(50) UNIQUE NOT NULL,
    password CHAR(60) NOT NULL,
    nombre_completo VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    activo BOOLEAN DEFAULT TRUE
);

CREATE TABLE clientes (
    id_cliente INT AUTO_INCREMENT PRIMARY KEY,
    usuario VARCHAR(50) UNIQUE NOT NULL,
    password CHAR(60) NOT NULL,
    nombre VARCHAR(50) NOT NULL,
    apellido VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    telefono VARCHAR(20),
    saldo DECIMAL(15, 2) DEFAULT 0.00 NOT NULL,
    direccion VARCHAR(255),
    imagen_perfil_url VARCHAR(255) DEFAULT '/assets/images/perfil/default-avatar.png',
    activo BOOLEAN DEFAULT TRUE
);

CREATE TABLE recuperacion_password (
    id_recuperacion INT AUTO_INCREMENT PRIMARY KEY,
    id_cliente INT NOT NULL,
    token VARCHAR(100) UNIQUE NOT NULL,
    fecha_expiracion TIMESTAMP NOT NULL,
    utilizado BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (id_cliente) REFERENCES clientes(id_cliente) ON DELETE CASCADE
);

CREATE TABLE categorias (
    id_categoria INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) UNIQUE NOT NULL,
    descripcion VARCHAR(255)
);

CREATE TABLE productos (
    id_producto INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    descripcion TEXT,
    precio DECIMAL(10, 2) NOT NULL,
    id_categoria INT NOT NULL,
    cantidad_disponible INT DEFAULT 0,
    cantidad_minima INT DEFAULT 5,
    es_temporada BOOLEAN DEFAULT FALSE,
    temporada VARCHAR(50),
    imagen_url VARCHAR(255),
    activo BOOLEAN DEFAULT TRUE,
    creado_por INT NOT NULL,
    FOREIGN KEY (id_categoria) REFERENCES categorias(id_categoria),
    FOREIGN KEY (creado_por) REFERENCES administradores(id_administrador)
);

CREATE TABLE pedidos (
    id_pedido INT AUTO_INCREMENT PRIMARY KEY,
    id_cliente INT NOT NULL,
    fecha_pedido TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    estado ENUM('Pendiente', 'Enviado', 'Completado', 'Cancelado') NOT NULL DEFAULT 'Pendiente',
    total DECIMAL(10, 2) NOT NULL,
    direccion_entrega VARCHAR(255) NOT NULL,
     latitud DECIMAL(10, 8),
      longitud DECIMAL(11, 8),
    FOREIGN KEY (id_cliente) REFERENCES clientes(id_cliente)
);

CREATE TABLE detalle_pedidos (
    id_detalle INT AUTO_INCREMENT PRIMARY KEY,
    id_pedido INT NOT NULL,
    id_producto INT NOT NULL,
    cantidad INT NOT NULL,
    precio_unitario DECIMAL(10, 2) NOT NULL,
    subtotal DECIMAL(10, 2) NOT NULL,
    FOREIGN KEY (id_pedido) REFERENCES pedidos(id_pedido) ON DELETE CASCADE,
    FOREIGN KEY (id_producto) REFERENCES productos(id_producto),
    UNIQUE KEY uk_pedido_producto (id_pedido, id_producto)
);

CREATE TABLE favoritos (
    id_favorito INT AUTO_INCREMENT PRIMARY KEY,
    id_cliente INT NOT NULL,
    id_producto INT NOT NULL,
    FOREIGN KEY (id_cliente) REFERENCES clientes(id_cliente) ON DELETE CASCADE,
    FOREIGN KEY (id_producto) REFERENCES productos(id_producto) ON DELETE CASCADE,
    UNIQUE KEY uk_cliente_producto (id_cliente, id_producto)
);

INSERT INTO administradores (usuario, password, nombre_completo, email, activo) VALUES
('admin', '$2a$10$ZMKGAxQ467/IZRj.O9Lgg.XrCXe8OSRofob.ePF.4.P5RdTOuIgqu', 'Jefe Desesperación', 'admin@desesperanza.com', TRUE),
('panadero1', '$2a$10$LgoJdtuYSWZz5Q5qY9UzeOfqjcBPbO.n1mzWbjtJ6fQwnXfcDaFeK', 'Panadero Espectral', 'panadero1@desesperanza.com', TRUE);


INSERT INTO categorias (nombre, descripcion) VALUES
('Panes Dulces', 'Variedad de panadería dulce tradicional.'),
('Salados', 'Opciones de pan salado, baguettes y más.'),
('Postres', 'Tartas, pasteles y otras delicias dulces.');

SET @id_admin = (SELECT id_administrador FROM administradores WHERE usuario = 'admin' LIMIT 1);
SET @cat_salados = (SELECT id_categoria FROM categorias WHERE nombre = 'Salados' LIMIT 1);
SET @cat_dulces = (SELECT id_categoria FROM categorias WHERE nombre = 'Panes Dulces' LIMIT 1);
SET @cat_postres = (SELECT id_categoria FROM categorias WHERE nombre = 'Postres' LIMIT 1);

INSERT INTO productos 
(nombre, descripcion, precio, id_categoria, cantidad_disponible, cantidad_minima, es_temporada, temporada, imagen_url, creado_por, activo) 
VALUES 
('Bolillo Artesanal', 'El clásico bolillo crujiente por fuera e indestructible por dentro, horneado el día del nacimiento de cristo.', 5.00, @cat_salados, 200, 50, FALSE, NULL, '/assets/images/panes/bolillo.jpg', @id_admin, TRUE);


SELECT id_producto, nombre, id_categoria FROM productos WHERE nombre IN ('Bolillo Artesanal' );



UPDATE productos SET imagen_url = '/assets/images/panes/bolillo.webp' WHERE nombre LIKE '%Bolillo%';

INSERT INTO productos 
(nombre, descripcion, precio, id_categoria, cantidad_disponible, cantidad_minima, es_temporada, temporada, imagen_url, creado_por, activo) 
VALUES 
('Cuernito de Mantequilla', 'Croissant clásico, hojaldrado y lleno de mantequilla.', 12.00, @cat_dulces, 60, 10, FALSE, NULL, '/assets/images/panes/cuernito.jpg', @id_admin, TRUE),

('Concha Santa Claus', 'Nuestra concha tradicional con decorado especial de Navidad.', 22.00, @cat_dulces, 100, 20, TRUE, 'Navidad', '/assets/images/panes/xmas-concha.jpg', @id_admin, TRUE),

('Croissant Festivo', 'Relleno de crema pastelera y decorado con colores navideños.', 25.00, @cat_dulces, 40, 10, TRUE, 'Navidad', '/assets/images/panes/xmas-croissant.jpg', @id_admin, TRUE),

('Dona Reno', 'Dona cubierta de chocolate con decoración de reno.', 20.00, @cat_postres, 80, 15, TRUE, 'Navidad', '/assets/images/panes/xmas-donut.jpg', @id_admin, TRUE),

('Muffin de Arándanos', 'Muffin especial de temporada con arándanos y escarcha de azúcar.', 28.00, @cat_postres, 50, 10, TRUE, 'Navidad', '/assets/images/panes/xmas-muffin.jpg', @id_admin, TRUE),

('Galleta Jengibre', 'Clásica galleta de jengibre decorada a mano.', 15.00, @cat_postres, 150, 30, TRUE, 'Navidad', '/assets/images/panes/xmas.cookie.jpg', @id_admin, TRUE);

SELECT id_producto, nombre, imagen_url, es_temporada FROM productos WHERE creado_por = @id_admin;